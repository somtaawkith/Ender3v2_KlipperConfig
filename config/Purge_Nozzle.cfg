[gcode_macro PURGE_NOZZLE]
description: "Universal prime + wipe macro (PLA, Bowden, 245°C, purge + wipe over bucket)"

# Pozycja kubełka i strefy czyszczenia
variable_bucket_x: 250            ; X coordinate for bucket (cleaning zone)
variable_ptfe_wipe: 235           ; X coordinate for wiping position (PTFE area)
variable_bucket_y: 5              ; Y coordinate for bucket/wipe zone

# Stała temperatura
variable_temp: 215                ; Static temperature (set externally, assumed already reached)

# Purge settings
variable_enable_purge: True
variable_purge_len: 45            ; Purge length (mm)
variable_purge_spd: 240           ; Purge speed
variable_post_purge_ret: 10       ; Additional retraction for Bowden systems (mm)
variable_post_purge_spd: 480      ; Retraction speed after purge (set explicitly, typically 2x purge_spd)
variable_ooze_dwell: 7            ; Dwell time (s) to allow pressure to stabilize

# Czyszczenie / Wipe settings
variable_wipe_qty: 5              ; Number of wipe passes

# Prędkości
variable_prep_spd_xy: 3000        ; XY preparation speed before purge
variable_prep_spd_z: 1500         ; Z preparation speed (unused here – Z nie jest zmieniane)
variable_wipe_spd_xy: 20000       ; XY speed during wipe movements

gcode:
    # Assume temperature is already set
    {# Check if all axes are homed – if not, abort execution #}
    {% if not printer.toolhead.homed_axes|length == 3 %}
        RESPOND MSG="ERROR: Must home all axes (G28) before running PURGE_NOZZLE"
    {% else %}
        G90                                    ; Use absolute positioning
        G1 X{bucket_x} Y{bucket_y} F{prep_spd_xy}  ; Move to bucket position

        M83                                    ; Set extruder to relative mode

        {% if enable_purge %}
            ;-------------------------------
            ; Purge Sequence: Extrude and Retract
            ;-------------------------------
            G1 E{purge_len} F{purge_spd}       ; Extrude purge length
            G4 S1                             ; Short dwell of 1 second
            G1 E-{post_purge_ret} F{post_purge_spd}  ; Retract filament at defined speed
            G4 S{ooze_dwell}                  ; Allow nozzle pressure to stabilize
        {% endif %}

        M82                                    ; Return to absolute extruder mode

        ;-------------------------------
        ; Move slightly and dwell before wipe
        ;-------------------------------
        G1 X{bucket_x - 5} Y{bucket_y} F{prep_spd_xy}  ; Slight retract from bucket edge
        G4 P500                                ; Dwell 500ms

        ;-------------------------------
        ; Wipe Routine: perform several X movements
        ;-------------------------------
        {% for i in range(wipe_qty) %}
            G1 X{ptfe_wipe - 10} Y{bucket_y} F{wipe_spd_xy}  ; Wipe left
            G4 P200                                         ; Short dwell between moves
            G1 X{ptfe_wipe + 10} Y{bucket_y} F{wipe_spd_xy}  ; Wipe right
            G4 P200                                         ; Short dwell between moves
        {% endfor %}

        ;-------------------------------
        ; Final small retract to further relieve pressure
        ;-------------------------------
        M83
        G1 E-0.8 F1200                        ; Final mini-retraction
        M82

        ;-------------------------------
        ; Return to home or park position
        ;-------------------------------
        G1 X0 Y0 F3000                        ; Move head to defined home/park position
    {% endif %}
