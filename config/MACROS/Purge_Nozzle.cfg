[gcode_macro PURGE_NOZZLE]
description: "Cleans nozzle over bucket, purges PLA with Bowden-safe temps, then cycles temps"
variable_location_bucket_rear: True
variable_enable_purge: True
variable_purge_len: 8              ; Mniejszy purge dla PLA
variable_purge_spd: 180            ; Bezpieczna prędkość wypychania
variable_purge_temp_min: 210       ; Minimalna temp. dla purgu PLA
variable_purge_ret: 5              ; Dłuższy retrakt dla Bowdena
variable_ooze_dwell: 5             ; Krótszy czas oczekiwania — PLA szybciej płynie
variable_brush_top: 7
variable_clearance_z: 5
variable_wipe_qty: 5
variable_prep_spd_xy: 3000
variable_prep_spd_z: 1500
variable_wipe_spd_xy: 5000

gcode:
    {% set nozzle_temp_high = 215 %}      ; Bezpieczne górne dla PLA
    {% set nozzle_temp_low = 200 %}       ; Dolne w zakresie PLA
    {% set cycles = 3 %}

    # Heat nozzle to starting temp
    M104 S{nozzle_temp_high}
    M109 S{nozzle_temp_high}

    # Move to bucket
    {% if location_bucket_rear %}
        G90
        G1 Z{clearance_z} F{prep_spd_z}
        G1 X5 Y5 F{prep_spd_xy}
    {% endif %}

    # Purge
    {% if enable_purge and nozzle_temp_high >= purge_temp_min %}
        G1 Z0.4 F{prep_spd_z}
        G1 E{purge_len} F{purge_spd}
        G4 S1
        G1 E-{purge_ret} F{purge_spd}
        G4 S{ooze_dwell}
        G1 Z{clearance_z} F{prep_spd_z}
    {% endif %}

    # Wipe (symulacja, brak fizycznej szczotki)
    {% for i in range(wipe_qty) %}
        G1 X15 Y5 F{wipe_spd_xy}
        G1 X0 Y5 F{wipe_spd_xy}
        G1 X10 Y5 F{wipe_spd_xy}
    {% endfor %}

    # Cykle temp
    {% for i in range(cycles) %}
        M104 S{nozzle_temp_low}
        M109 S{nozzle_temp_low}
        G1 X5 Y35 F{prep_spd_xy}
        G4 S1
        M104 S{nozzle_temp_high}
        M109 S{nozzle_temp_high}
        G1 X5 Y5 F{prep_spd_xy}
        G4 S1
    {% endfor %}

    # Park
    G1 Z10 F600
    G1 X0 Y0 F3000
