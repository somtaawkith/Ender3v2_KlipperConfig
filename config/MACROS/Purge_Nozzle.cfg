[gcode_macro PURGE_NOZZLE]
description: "Universal prime + wipe macro (PLA, Bowden, 245°C, purge + wipe over bucket)"

# Pozycja kubełka
variable_bucket_x: 245
variable_bucket_y: 5
variable_location_bucket_rear: True

# Stała temperatura
variable_temp: 215

# Purge
variable_enable_purge: True
variable_purge_len: 50               ; 50 mm purge
variable_purge_spd: 300              ; 5 mm/s = 300 mm/min
variable_post_purge_ret: 3
variable_ooze_dwell: 5

# Czyszczenie / Wipe
variable_wipe_qty: 5

# Prędkości
variable_prep_spd_xy: 3000
variable_prep_spd_z: 1500
variable_wipe_spd_xy: 5000

gcode:
    # Grzanie do zadanej temperatury
    M104 S{temp}
    M109 S{temp}

    # Przejście nad kubełek i ustawienie wysokości
    G90
    G1 X{bucket_x} Y{bucket_y} F{prep_spd_xy}
    G1 Z0.4 F{prep_spd_z} ; Stała wysokość do purge i wipe

    # PURGE
    {% if enable_purge %}
        G1 E{purge_len} F{purge_spd}
        G4 S1
        G1 E-{post_purge_ret} F{purge_spd}
        G4 S{ooze_dwell}
    {% endif %}

    # Oddzielenie purge od wipe — minimalny ruch + pauza
    G1 X{bucket_x + 2} Y{bucket_y} F{prep_spd_xy}
    G4 P500 ; pauza 0.5 sekundy

    # WIPE — ruchy poziome wokół pozycji kubełka
    {% for i in range(wipe_qty) %}
        G1 X{bucket_x + 15} Y{bucket_y} F{wipe_spd_xy}
        G1 X{bucket_x - 15} Y{bucket_y} F{wipe_spd_xy}
        G1 X{bucket_x + 5} Y{bucket_y} F{wipe_spd_xy}
    {% endfor %}

    # Zakończenie — opcjonalnie parkuj (możesz wywołać tu własne makro parkowania)
    G1 Z10 F600
    G1 X0 Y0 F3000
